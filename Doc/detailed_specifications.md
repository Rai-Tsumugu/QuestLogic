# SmartStudy Gate 詳細仕様書

本ドキュメントは、SmartStudy Gateの各機能分野における詳細な仕様を定義するものです。

---

## 1. ユーザー管理・認証 (User Management)
### 1.1 概要
一人の「親（管理者）」が複数の「子（学習者）」を管理できる、一対多（1:N）の構造とします。

### 1.2 アカウント構造
*   **Family Group (家族グループ)**:
    *   親アカウント作成時に自動生成されるユニークなグループID。
    *   全てのデータはこのFamily IDに紐付きます。
*   **Parent (親)**:
    *   権限: 全設定の変更、レポート閲覧、子供アカウントの追加・削除、ハードウェア解除。
    *   認証: Email/Password または Social Login (Google/Apple)。
*   **Child (子供)**:
    *   権限: クエスト（学習）の実行、撮影、報酬（時間）の消費。
    *   認証:
        *   **簡易ログイン**: 親の端末または共有タブレットでの「ユーザー切り替え」方式（PINコード入力）。
        *   **個人端末ログイン**: 親が発行したQRコードまたは招待リンクでログイン。

### 1.3 データモデル (Firestore想定)
*   **users**:
    *   `uid`: String (Auth ID)
    *   `role`: "parent" | "child"
    *   `familyId`: String (Reference)
    *   `displayName`: String
    *   `profileIcon`: String (URL)
*   **families**:
    *   `id`: String
    *   `parentUid`: String (Admin)
    *   `childUids`: Array<String>
    *   `subscriptionStatus`: "free" | "premium"

---

## 2. スマホでの撮影 (Camera Implementation)
### 2.1 撮影フロー
学習における「Before（着手前）」と「After（完了後）」の2回撮影を必須とします。

1.  **Before撮影 (クエスト開始)**:
    *   学習対象（ノート、ワーク）の現状を撮影。
    *   **ガイド表示**: 枠線や水準器を表示し、真上からの撮影を促す。
    *   **不正防止**: 撮影時のタイムスタンプと位置情報を記録。
2.  **After撮影 (クエスト完了)**:
    *   学習後の状態を撮影。
    *   **ゴースト表示**: Beforeで撮影した画像を半透明で重ねて表示し、同じ画角・倍率で撮影できるように誘導する（差分検出精度向上のため）。

### 2.2 画像処理
*   **解像度**: 通信量とAI解析精度のバランスから、長辺1920px程度にリサイズ。
*   **フォーマット**: JPEG (圧縮率80%) または WebP。
*   **メタデータ付与**: 撮影日時、端末情報、照度情報を画像またはリクエストボディに含める。

---

## 3. 画像保存 (Image Storage)
### 3.1 ディレクトリ構造
Cloud Storage (Firebase Storage等) を利用し、アクセス権限を厳格に管理します。

`storage_root / {familyId} / {childId} / {questId} / {imageType}.jpg`

*   `imageType`: `before`, `after`
*   **セキュリティルール**: `familyId` が一致する認証済みユーザーのみRead/Write可能。

### 3.2 ライフサイクル管理
*   **ホットデータ**: 直近3ヶ月以内の画像は即時アクセス可能。
*   **コールドデータ**: 3ヶ月経過後は、レポート用のサムネイル（低解像度）のみを残し、原本は削除またはArchiveストレージへ移動（プライバシー保護とコスト削減）。
*   **削除ポリシー**: 退会時またはユーザーからの削除リクエスト時に物理削除。

---

## 4. AIによる言語化・分析 (AI Analysis)
### 4.1 分析ロジック (Gemini 活用)
画像とメタデータをGemini APIに送信し、以下の観点で言語化・スコアリングを行います。

1.  **差分解析 (Volume)**: Before/Afterのピクセル差分と、手書き文字の密度から「作業量」を判定。
2.  **プロセス評価 (Quality)**:
    *   消しゴムの跡 → 「試行錯誤した」
    *   赤ペンの修正 → 「振り返りをした」
    *   丁寧な図や文字 → 「誠実に取り組んだ」
3.  **不正検知 (Fraud)**:
    *   筆跡の劇的な変化 → 「代筆の疑い」
    *   極端に短い時間での大量の記述 → 「書き写しの疑い」

### 4.2 プロンプト構成
AIに対し「子供を励ますコーチ」のペルソナを与えます。
> "あなたは子供の自律学習を支援するAIコーチです。単なる正誤判定ではなく、努力のプロセス（消し跡、丁寧さ）を見つけて褒めてください。親向けの客観的レポートと、子供向けの励ましコメントをJSONで出力してください。"

---

## 5. 分析結果・言語化の保存 (Data Persistence)
### 5.1 保存データ構造
AIの出力結果を正規化してデータベースに保存します。

*   **quest_results**:
    *   `questId`: String
    *   `childId`: String
    *   `timestamp`: Timestamp
    *   `score`: Number (0-100)
    *   `scoreBreakdown`: { volume: Number, quality: Number, review: Number }
    *   `childComment`: String (子供が任意で入力する感想)
    *   `aiComments`:
        *   `forChild`: String (子供向けメッセージ)
        *   `forParent`: String (親向けレポート)
    *   `tags`: Array<String> (例: "丁寧", "解き直し", "集中")
    *   `status`: "pending_parent_review" | "approved" | "rejected"

---

## 6. ユーザー（子）へのコメント (Feedback to Child)
### 6.1 コメント生成方針
*   **ポジティブフィードバック**: 「ダメ出し」はせず、「褒める」ことを基本とする。
*   **具体性**: 「すごいね」だけでなく、「図を書いて考えた跡がすごいね！」「計算ミスを自分で直していて偉い！」など、具体的な行動を指摘する。
*   **キャラクター性**: アプリ内のRPGキャラクター（相棒）の口調で語りかける。

### 6.2 UI表示
*   リザルト画面にて、キャラクターの吹きだしとして表示。
*   特に良い点（Good Point）はハイライト表示やエフェクト付きで演出。

---

## 7. ユーザー（子）のスクリーンタイム設定 (Gamification)
### 7.1 "努力"の通貨換算ロジック
学習の成果を、遊びの時間（報酬）に変換します。

`獲得時間(分) = (基本時間 × AIスコア係数) + ボーナス`
※子供はクエスト完了時に任意で感想を入力できるが、感想記述の有無は獲得時間（基本時間やボーナス）の計算には影響しない。

*   **基本時間**: 親があらかじめ設定（例: 宿題1回 = 15分）。
*   **AIスコア係数**: AI評価(0.5 ~ 1.5倍)で変動。丁寧やるほど時間が増える。
*   **ボーナス**: 「3日連続達成」「解き直しあり」などで追加時間(+5分など)。

*   **配布タイミング (報酬配分)**:
    *   計算された総獲得時間は「AIの解析完了時」と「親の承認時」に分割して子供に付与される。
    *   デフォルトの配分比率は **AI : 親 = 2 : 1**。
    *   この比率は保護者が設定画面等からカスタマイズ可能（`family` 設定として保持）。

### 7.2 物理デバイス連携 (IoT)
*   報酬として獲得した時間は「Energy」としてアプリ内にストック。
*   **解錠フロー**:
    1.  アプリで「遊ぶ」ボタンを押す（Energy消費開始）。
    2.  スマホを「Smart-Gate Box（収納箱）」のNFCにかざす。
    3.  箱が解錠され、ゲーム機を取り出せる。
*   **終了フロー**:
    1.  遊び終わったらゲーム機を箱に戻す。
    2.  箱を閉め、スマホを再度かざす（施錠確認）。
    3.  Energy消費が停止。

---

## 8. ユーザー（親）による確認機能 (Parent Dashboard)
### 8.1 リアルタイム通知
*   子供がクエスト（宿題）を完了した瞬間にPush通知。
*   「〇〇くんが宿題を完了しました！AI評価: 85点」

### 8.2 確認・承認フロー
親はアプリのタイムラインまたは詳細画面で以下を確認できます。

1.  **Before/After画像の比較**: スライダーで変化を確認可能。
2.  **AI分析レポート**: AIが検出した「努力ポイント」や「懸念点（不正の可能性）」の表示。
3.  **子供の感想**: 子供がクエスト完了時に入力した「感想」の表示。
4.  **アクション**:
    *   **承認 (Approve)**: AIの評価を確定させる（スタンプを送る）。未付与分のエネルギー（配分比率に応じた残りの分）が子供に付与される。
    *   **修正 (Correction)**: 「字が汚すぎる」等、親の基準でスコアや報酬を下方修正する（AIの再学習データとして蓄積）。
    *   **却下 (Reject)**: やり直しを命じる。

### 8.3 成長ログ
*   週間/月間の学習推移グラフ。
*   AIが作成した「今週の頑張り」サマリーレポート。
