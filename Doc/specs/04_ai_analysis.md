# 04_ai_analysis.md

## 概要
Gemini APIを用いた画像解析ロジック、プロンプト設計、およびバックエンドAPI仕様。
ユーザーシナリオに基づき、「結果」だけでなく「過程（プロセス）」を詳細に評価し、子供のモチベーションを高めるフィードバック生成を重視する。

## AI ロジック
*   **Model**: `gemini-1.5-pro` (or `gemini-1.5-flash` for latency/cost balance)
*   **Inputs**:
    1.  `Before Image` (Binary): 学習前のノート
    2.  `After Image` (Binary): 学習後のノート
    3.  `Metadata` (JSON): `{ subject: "算数", durationMin: 30, ... }`
    4.  `System Prompt` (Text)

## プロンプト設計 (System Prompt)
```text
あなたは、子供（中学生）の自律的な学習を支援する、頼れる相棒のような「AIコーチ」です。
画像1は学習前、画像2は学習後のノートです。これらを比較・分析し、子供の努力を最大限に評価してください。

# 分析の視点
1. **Delta解析 (量)**: 
   - Before/Afterの差分から、筆記量がどの程度増えたか。
   - 30分学習したとして、量は妥当か？（5分で書き殴ったような量/質ではないか？）
2. **Process解析 (質・痕跡)**: 
   - **消しゴム修正**: 思考の試行錯誤の証拠として高く評価せよ。「間違えても直した」ことは素晴らしい。
   - **赤ペン/青ペン**: 丸付けや解き直し、解説の書き込みはあるか？「振り返り」の証拠。
   - **図・表・メモ**: 問題を解くために独自に書いた図や計算メモはあるか？
   - **丁寧さ**: 字の上手下手ではなく、「その子なりに丁寧に書こうとしたか」を見る。

# 出力フォーマット (JSONのみ)
{
  "score": 0-100の整数,
  "score_breakdown": {
    "volume": 0-10, // 作業量
    "quality": 0-10, // 丁寧さ・工夫
    "process": 0-10 // 試行錯誤（消し跡、解き直し）★重要
  },
  "feedback_child": "子供へのメッセージ（140文字以内）。
     - 口調: 親しみやすいRPGの相棒キャラ（「〜だね！」「〜ですごい！」）。
     - 内容: 具体的な行動を褒める。「問3の図を書いた跡、しっかり考えてる証拠だよ！」「計算ミスを自分で直したのも偉い！」など、発見した痕跡に言及すること。",
  "feedback_parent": "親へのレポート（200文字以内）。
     - 内容: 客観的な評価。「全体的に丁寧です」「図を書いて考える工夫が見られます」等。
     - 懸念点: 不正（書き写し、時間不相応な量）の疑いがあれば指摘。",
  "tags": ["丁寧", "計算ミス修正", "図解あり", "解き直し", "書き殴り疑い"],
  "detected_features": [ // UIでのハイライト表示用
    { "type": "erasure", "description": "消しゴムでの修正跡" },
    { "type": "red_pen", "description": "赤ペンでの解き直し" }
  ]
}
```

## API インターフェース
**Endpoint**: `POST /api/analyze`

### Request
`multipart/form-data`
*   `beforeImage`: File
*   `afterImage`: File
*   `metadata`: JSON String `{ "subject": "Math", "durationMin": 30 }`

### Response
```json
{
  "success": true,
  "result": {
    "score": 85,
    "score_breakdown": { "volume": 8, "quality": 7, "process": 9 },
    "feedback_child": "すごい！30分でこれだけ進めたね！特に問3の図を書いた跡、しっかり考えてる証拠だよ！計算ミスを自分で直したのも偉い！",
    "feedback_parent": "30分間の学習成果として十分な量です。特に途中の計算ミスを消しゴムで修正し、赤ペンで解説を書き込んでいる点から、深い理解への努力が見られます。",
    "tags": ["解き直し", "図解あり"],
    "detected_features": [...]
  }
}
```

## エラーハンドリング
*   **画像不鮮明**: AIが判読不能とした場合、再撮影を促すエラー `IMAGE_UNCLEAR` を返す。
*   **被写体不適切**: ノート以外の画像の場合、警告 `INVALID_SUBJECT` を返す。

## 受け入れ条件 (Acceptance Criteria)
1.  **プロセス評価**: 消しゴム跡や赤ペンの修正がある画像に対し、`process`スコアが高くなり、コメントでもその点に言及されること。
2.  **不正検知**: 極端に短い時間での大量記述（書き写し）に対し、スコアを低くし（例: 15点）、相応のコメント（「速すぎるかも？」）を返すこと。
