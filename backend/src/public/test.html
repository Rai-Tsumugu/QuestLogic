<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuestLogic - çµ±åˆãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚¿ãƒ«</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f3f4f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { color: #4f46e5; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        .card { background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
        button { background: #4f46e5; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 8px; }
        button:hover { background: #4338ca; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-parent { background: #10b981; }
        .btn-parent:hover { background: #059669; }
        input[type="file"], input[type="number"], input[type="text"] { margin-top: 8px; margin-bottom: 16px; display: block; padding: 8px; width: 100%; max-width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        pre { background: #1f2937; color: #10b981; padding: 16px; border-radius: 8px; overflow-x: auto; max-height: 400px; white-space: pre-wrap; }
        .flex { display: flex; gap: 20px; }
        .badge { background: #10b981; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ QuestLogic çµ±åˆãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚¿ãƒ«</h1>
        
        <div class="card">
            <h2>1. èªè¨¼ (Auth) - å½¹å‰²åˆ‡ã‚Šæ›¿ãˆ</h2>
            <button onclick="devLogin('child')">ğŸ‘¦ å­ä¾›ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="devLogin('parent')" class="btn-parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ è¦ªã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
            <p>ç¾åœ¨ã®çŠ¶æ…‹: <span id="authStatus" style="color:red; font-weight:bold;">æœªãƒ­ã‚°ã‚¤ãƒ³</span></p>
            <p>ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ(ã‚²ãƒ¼ãƒ æ™‚é–“): <span id="pointsDisplay" class="badge">0 åˆ†</span></p>
        </div>

        <div class="flex">
            <div class="card" style="flex: 1;">
                <h2>2. ã‚¯ã‚¨ã‚¹ãƒˆæå‡º (å­ä¾›å°‚ç”¨)</h2>
                <form id="questForm">
                    <input type="file" id="beforeImage" accept="image/*" required>
                    <input type="file" id="afterImage" accept="image/*" required>
                    <button type="submit" id="submitBtn" disabled>AIåˆ†æé–‹å§‹</button>
                </form>
            </div>

            <div class="card" style="flex: 1;">
                <h2>3. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
                <label>å¯¾è±¡ã‚¯ã‚¨ã‚¹ãƒˆID:</label>
                <input type="text" id="questId" placeholder="æå‡ºå¾Œã«è‡ªå‹•å…¥åŠ›">
                
                <button onclick="addBonus()" id="bonusBtn" class="btn-parent" disabled>ğŸ è¦ªã®ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸ (+10åˆ†)</button>
                <hr style="margin: 16px 0;">
                
                <label>æ¶ˆè²»ã™ã‚‹æ™‚é–“ (åˆ†):</label>
                <input type="number" id="consumeAmount" value="15">
                <button onclick="consumePoints()" id="consumeBtn" disabled style="background:#ef4444;">ğŸ® ãƒ­ãƒƒã‚¯è§£é™¤ (ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»)</button>
            </div>
        </div>

        <h2>å®Ÿè¡Œãƒ­ã‚° / ãƒ¬ã‚¹ãƒãƒ³ã‚¹</h2>
        <pre id="output">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†...</pre>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3000/api';
        let jwtToken = '';
        let currentUser = null;
        let currentRole = '';

        function log(message, data = null) {
            const time = new Date().toLocaleTimeString();
            let text = `[${time}] ${message}\n`;
            if (data) text += JSON.stringify(data, null, 2) + '\n';
            document.getElementById('output').textContent = text + "------------------------\n" + document.getElementById('output').textContent;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function devLogin(role) {
            try {
                const res = await fetch(`${BASE_URL}/test/login/${role}`);
                const data = await res.json();
                
                if (data.success) {
                    jwtToken = data.token;
                    currentUser = data.user;
                    currentRole = role;
                    
                    document.getElementById('authStatus').textContent = `ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${currentUser.name} (${currentUser.role})`;
                    document.getElementById('authStatus').style.color = 'green';
                    document.getElementById('pointsDisplay').textContent = `${currentUser.currentPoints} åˆ†`;
                    
                    // å½¹å‰²ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
                    document.getElementById('submitBtn').disabled = (role !== 'child');
                    document.getElementById('consumeBtn').disabled = (role !== 'child');
                    document.getElementById('bonusBtn').disabled = (role !== 'parent');
                    
                    log(`[${currentUser.role}] ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚`, data.user);
                }
            } catch (err) {
                log("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼", err.message);
            }
        }

        // ã‚¯ã‚¨ã‚¹ãƒˆæå‡º
        document.getElementById('questForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentRole !== 'child') return alert("å­ä¾›ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");

            const formData = new FormData();
            formData.append('beforeImage', document.getElementById('beforeImage').files[0]);
            formData.append('afterImage', document.getElementById('afterImage').files[0]);
            formData.append('childId', currentUser.id);
            formData.append('familyId', currentUser.familyId);

            document.getElementById('submitBtn').textContent = "AIåˆ†æä¸­...";
            document.getElementById('submitBtn').disabled = true;

            try {
                const res = await fetch(`${BASE_URL}/quests/submit`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}` },
                    body: formData
                });
                const data = await res.json();
                log("AIåˆ†æå®Œäº†", data);

                if (data.success) {
                    document.getElementById('questId').value = data.data.id;
                    devLogin('child'); // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæœ€æ–°åŒ–
                }
            } catch (err) {
                log("ã‚¨ãƒ©ãƒ¼", err.message);
            } finally {
                document.getElementById('submitBtn').textContent = "AIåˆ†æé–‹å§‹";
                document.getElementById('submitBtn').disabled = false;
            }
        });

        // ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸
        async function addBonus() {
            if (currentRole !== 'parent') return alert("è¦ªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            const questId = document.getElementById('questId').value;
            
            try {
                const res = await fetch(`${BASE_URL}/quests/${questId}/bonus`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bonusPoints: 10 })
                });
                const data = await res.json();
                log("ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸çµæœ", data);
            } catch (err) { log("ã‚¨ãƒ©ãƒ¼", err.message); }
        }

        // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
        async function consumePoints() {
            if (currentRole !== 'child') return alert("å­ä¾›ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            const minutes = document.getElementById('consumeAmount').value;
            
            try {
                const res = await fetch(`${BASE_URL}/users/consume-points`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ minutes: Number(minutes) })
                });
                const data = await res.json();
                log("ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»çµæœ", data);
                if(data.success) devLogin('child');
            } catch (err) { log("ã‚¨ãƒ©ãƒ¼", err.message); }
        }
    </script>
</body>
</html>