<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuestLogic - çµ±åˆãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚¿ãƒ« (RPG Update)</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f3f4f6; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { color: #4f46e5; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        .card { background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
        button { background: #4f46e5; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 8px; margin-bottom: 8px; }
        button:hover { background: #4338ca; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-parent { background: #10b981; }
        .btn-parent:hover { background: #059669; }
        .btn-profile { background: #f59e0b; }
        .btn-profile:hover { background: #d97706; }
        
        /* CSSã« select ã‚’è¿½åŠ ã—ã¦ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’çµ±ä¸€ */
        input[type="file"], input[type="number"], input[type="text"], select { 
            margin-top: 8px; margin-bottom: 16px; display: block; padding: 8px; width: 100%; max-width: 300px; border: 1px solid #ccc; border-radius: 4px; background-color: white; 
        }
        
        pre { background: #1f2937; color: #10b981; padding: 16px; border-radius: 8px; overflow-x: auto; max-height: 400px; white-space: pre-wrap; }
        .flex { display: flex; gap: 20px; flex-wrap: wrap; }
        .badge { background: #10b981; color: white; padding: 6px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; margin-right: 5px; }
        .badge.lv { background: #f59e0b; }
        .badge.exp { background: #3b82f6; }
        .profile-text { font-size: 14px; color: #4b5563; margin-top: 8px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ QuestLogic çµ±åˆãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚¿ãƒ« (RPG Update)</h1>
        
        <div class="card">
            <h2>1. èªè¨¼ (Auth) - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ</h2>
            <button onclick="devLogin('child')">ğŸ‘¦ å­ä¾›ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="devLogin('parent')" class="btn-parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ è¦ªã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
            
            <p>ç¾åœ¨ã®çŠ¶æ…‹: <span id="authStatus" style="color:red; font-weight:bold;">æœªãƒ­ã‚°ã‚¤ãƒ³</span></p>
            
            <div style="margin-top: 10px;">
                <span class="badge lv">Lv.<span id="levelDisplay">1</span></span>
                <span class="badge exp">EXP: <span id="expDisplay">0</span></span>
                <span class="badge">ã‚²ãƒ¼ãƒ æ™‚é–“: <span id="pointsDisplay">0</span> åˆ†</span>
            </div>
            
            <div class="profile-text">
                ğŸ“š å­¦å¹´: <span id="gradeDisplay">æœªè¨­å®š</span> | 
                âœ¨ å¾—æ„ãªã“ã¨: <span id="specialtyDisplay">æœªè¨­å®š</span>
            </div>
        </div>

        <div class="flex">
            <div class="card" style="flex: 1; min-width: 300px;">
                <h2>2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°</h2>
                <label>å­¦å¹´:</label>
                <select id="gradeInput">
                    <option value="">æœªè¨­å®š (é¸æŠã—ã¦ãã ã•ã„)</option>
                    <option value="å°1">å°å­¦1å¹´ç”Ÿ (å°1)</option>
                    <option value="å°2">å°å­¦2å¹´ç”Ÿ (å°2)</option>
                    <option value="å°3">å°å­¦3å¹´ç”Ÿ (å°3)</option>
                    <option value="å°4">å°å­¦4å¹´ç”Ÿ (å°4)</option>
                    <option value="å°5">å°å­¦5å¹´ç”Ÿ (å°5)</option>
                    <option value="å°6">å°å­¦6å¹´ç”Ÿ (å°6)</option>
                    <option value="ä¸­1">ä¸­å­¦1å¹´ç”Ÿ (ä¸­1)</option>
                    <option value="ä¸­2">ä¸­å­¦2å¹´ç”Ÿ (ä¸­2)</option>
                    <option value="ä¸­3">ä¸­å­¦3å¹´ç”Ÿ (ä¸­3)</option>
                    <option value="é«˜1">é«˜æ ¡1å¹´ç”Ÿ (é«˜1)</option>
                    <option value="é«˜2">é«˜æ ¡2å¹´ç”Ÿ (é«˜2)</option>
                    <option value="é«˜3">é«˜æ ¡3å¹´ç”Ÿ (é«˜3)</option>
                </select>
                
                <label>å¾—æ„ãªã“ã¨ (ä¾‹: ç®—æ•°ã€å·¥ä½œ):</label>
                <input type="text" id="specialtyInput" placeholder="å¾—æ„ãªã“ã¨ã‚’å…¥åŠ›">
                
                <button onclick="updateProfile()" id="profileBtn" class="btn-profile" disabled>ğŸ“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜</button>
            </div>

            <div class="card" style="flex: 1; min-width: 300px;">
                <h2>3. ã‚¯ã‚¨ã‚¹ãƒˆæå‡º (å­ä¾›å°‚ç”¨)</h2>
                <form id="questForm">
                    <input type="file" id="beforeImage" accept="image/*" required>
                    <input type="file" id="afterImage" accept="image/*" required>
                    <button type="submit" id="submitBtn" disabled>âš”ï¸ AIåˆ†æã§çµŒé¨“å€¤ã‚²ãƒƒãƒˆï¼</button>
                </form>
            </div>

            <div class="card" style="flex: 1; min-width: 300px;">
                <h2>4. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (å ±é…¬/æ¶ˆè²»)</h2>
                <label>å¯¾è±¡ã‚¯ã‚¨ã‚¹ãƒˆID:</label>
                <input type="text" id="questId" placeholder="æå‡ºå¾Œã«è‡ªå‹•å…¥åŠ›">
                <button onclick="addBonus()" id="bonusBtn" class="btn-parent" disabled>ğŸ è¦ªã®ãƒœãƒ¼ãƒŠã‚¹ (+10åˆ†)</button>
                
                <hr style="margin: 16px 0;">
                
                <label>æ¶ˆè²»ã™ã‚‹æ™‚é–“ (åˆ†):</label>
                <input type="number" id="consumeAmount" value="15">
                <button onclick="consumePoints()" id="consumeBtn" disabled style="background:#ef4444;">ğŸ® ãƒ­ãƒƒã‚¯è§£é™¤ (ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»)</button>
            </div>
        </div>

        <h2>å®Ÿè¡Œãƒ­ã‚° / ãƒ¬ã‚¹ãƒãƒ³ã‚¹</h2>
        <pre id="output">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†...</pre>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3000/api';
        let jwtToken = '';
        let currentUser = null;
        let currentRole = '';

        function log(message, data = null) {
            const time = new Date().toLocaleTimeString();
            let text = `[${time}] ${message}\n`;
            if (data) text += JSON.stringify(data, null, 2) + '\n';
            document.getElementById('output').textContent = text + "------------------------\n" + document.getElementById('output').textContent;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function devLogin(role) {
            try {
                const res = await fetch(`${BASE_URL}/test/login/${role}`);
                const data = await res.json();
                
                if (data.success) {
                    jwtToken = data.token;
                    currentUser = data.user;
                    currentRole = role;
                    
                    document.getElementById('authStatus').textContent = `ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${currentUser.name} (${currentUser.role})`;
                    document.getElementById('authStatus').style.color = 'green';
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
                    document.getElementById('levelDisplay').textContent = currentUser.level || 1;
                    document.getElementById('expDisplay').textContent = currentUser.exp || 0;
                    document.getElementById('pointsDisplay').textContent = currentUser.currentPoints || 0;
                    
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–° (ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å€¤ã‚’ã‚»ãƒƒãƒˆ)
                    document.getElementById('gradeDisplay').textContent = currentUser.grade || 'æœªè¨­å®š';
                    document.getElementById('specialtyDisplay').textContent = currentUser.specialty || 'æœªè¨­å®š';
                    
                    // DBã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å­¦å¹´ã¨ä¸€è‡´ã™ã‚‹optionã‚’è‡ªå‹•é¸æŠ
                    document.getElementById('gradeInput').value = currentUser.grade || '';
                    document.getElementById('specialtyInput').value = currentUser.specialty || '';
                    
                    document.getElementById('submitBtn').disabled = (role !== 'child');
                    document.getElementById('consumeBtn').disabled = (role !== 'child');
                    document.getElementById('bonusBtn').disabled = (role !== 'parent');
                    document.getElementById('profileBtn').disabled = false;
                    
                    log(`[${currentUser.role}] ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
                }
            } catch (err) {
                log("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼", err.message);
            }
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°å‡¦ç†
        async function updateProfile() {
            const grade = document.getElementById('gradeInput').value;
            const specialty = document.getElementById('specialtyInput').value;
            
            log("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...");
            try {
                const res = await fetch(`${BASE_URL}/users/profile`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${jwtToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ grade, specialty })
                });
                const data = await res.json();
                log("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°çµæœ", data);
                if(data.success) {
                    devLogin(currentRole); 
                    alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
                }
            } catch (err) { log("ã‚¨ãƒ©ãƒ¼", err.message); }
        }

        // ã‚¯ã‚¨ã‚¹ãƒˆæå‡º (ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡ºä»˜ã)
        document.getElementById('questForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentRole !== 'child') return alert("å­ä¾›ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");

            const formData = new FormData();
            formData.append('beforeImage', document.getElementById('beforeImage').files[0]);
            formData.append('afterImage', document.getElementById('afterImage').files[0]);
            formData.append('childId', currentUser.id);
            formData.append('familyId', currentUser.familyId);

            document.getElementById('submitBtn').textContent = "AIåˆ†æä¸­...";
            document.getElementById('submitBtn').disabled = true;

            try {
                const res = await fetch(`${BASE_URL}/quests/submit`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}` },
                    body: formData
                });
                const data = await res.json();
                log("AIåˆ†æå®Œäº†", data);

                if (data.success) {
                    document.getElementById('questId').value = data.data.id;
                    
                    if (data.isLevelUp) {
                        alert(`ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼ ğŸ‰\n\næ–°ã—ã„ãƒ¬ãƒ™ãƒ«: Lv.${data.newLevel}\nã€Œã‚ˆããŒã‚“ã°ã‚Šã¾ã—ãŸï¼ã€`);
                    } else {
                        alert(`çµŒé¨“å€¤ã‚’ç²å¾—ã—ã¾ã—ãŸï¼\nç²å¾—ã‚²ãƒ¼ãƒ æ™‚é–“: ${data.data.earnedPoints}åˆ†`);
                    }
                    
                    devLogin('child');
                }
            } catch (err) {
                log("ã‚¨ãƒ©ãƒ¼", err.message);
            } finally {
                document.getElementById('submitBtn').textContent = "âš”ï¸ AIåˆ†æã§çµŒé¨“å€¤ã‚²ãƒƒãƒˆï¼";
                document.getElementById('submitBtn').disabled = false;
            }
        });

        // ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸
        async function addBonus() {
            if (currentRole !== 'parent') return alert("è¦ªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            const questId = document.getElementById('questId').value;
            
            try {
                const res = await fetch(`${BASE_URL}/quests/${questId}/bonus`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bonusPoints: 10 })
                });
                const data = await res.json();
                log("ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸çµæœ", data);
            } catch (err) { log("ã‚¨ãƒ©ãƒ¼", err.message); }
        }

        // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
        async function consumePoints() {
            if (currentRole !== 'child') return alert("å­ä¾›ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            const minutes = document.getElementById('consumeAmount').value;
            
            try {
                const res = await fetch(`${BASE_URL}/users/consume-points`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ minutes: Number(minutes) })
                });
                const data = await res.json();
                log("ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»çµæœ", data);
                if(data.success) devLogin('child');
            } catch (err) { log("ã‚¨ãƒ©ãƒ¼", err.message); }
        }
    </script>
</body>
</html>